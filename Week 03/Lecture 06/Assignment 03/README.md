# üë®üèª‚Äçüè´ Lecture 06 - RESTful API & Relational Database
> This repository is created as a part of assignment for Lecture 06 - RESTful API & Relational Database

## üõ¢Ô∏è Assignment 03 - Relational Database Queries
### 1Ô∏è‚É£ Creating a View: Products Customers Bought

**Objective**: Create a view to list products that customers bought, including details such as customer ID, customer name, product ID, product name, quantity, amount, and the invoice creation date.

A view is a virtual table that provides a way to look at data in the database without having to directly query multiple tables each time. In this case, we'll join the `customer`, `invoice`, `invoice_detail`, and `product` tables to aggregate the necessary information.

Here is the SQL query.

```sql
CREATE VIEW customer_purchases AS
SELECT
    c.id AS customer_id,
    c.name AS customer_name,
    p.id AS product_id,
    p.name AS product_name,
    id.quantity,
    id.amount,
    i.created_date
FROM
    customer c
    JOIN invoice i ON c.id = i.customer_id
    JOIN invoice_detail id ON i.id = id.invoice_id
    JOIN product p ON id.product_id = p.id;
```

Here is the explanation on what the query actually done.
1. **Joins**: Connect `customer` to `invoice` using `customer_id`, then `invoice` to `invoice_detail` using `invoice_id`, and finally `invoice_detail` to `product` using `product_id`.
2. **Select Fields**: Choose fields from each table that are necessary for the report.
3. **View Creation**: Create the view `customer_purchases` to encapsulate this query.

By using the dummy data from previous assignment, here the result of the view.

![Screenshots](/Week%2003/Lecture%2006/Assignment%2003/img/Task1.png)
<br>

### 2Ô∏è‚É£ Creating a Function: Calculate Revenue by Cashier

**Objective**: Create a function that calculates total revenue for a given cashier by summing up the `amount` in invoices handled by that cashier.

A function in SQL returns a single value. We'll create a function that takes a `cashier_id` and returns the total revenue generated by that cashier.

Here is the SQL query.

```sql
DELIMITER //

CREATE FUNCTION calculate_revenue_by_cashier(cashier_id INT)
RETURNS DECIMAL(10, 2)
DETERMINISTIC
BEGIN
    DECLARE total_revenue DECIMAL(10, 2);
    SELECT SUM(amount) INTO total_revenue
    FROM invoice
    WHERE cashier_id = cashier_id;
    RETURN IFNULL(total_revenue, 0);
END //

DELIMITER ;
```

Here is the explanation on what the query actually done.
1. **Function Definition**: Define `calculate_revenue_by_cashier` to return a `DECIMAL(10, 2)`.
2. **Declare Variable**: Use `total_revenue` to store the sum of amounts.
3. **Calculate Revenue**: Use a `SELECT` query to sum up the `amount` from invoice for the given `cashier_id`.
4. **Return**: Return the calculated `total_revenue`.

By using the dummy data from previous assignment, here the result of the view.

![Screenshots](/Week%2003/Lecture%2006/Assignment%2003/img/Task2.png).
<br>

### 3Ô∏è‚É£ Creating a Table: `revenue_report`

**Objective**: Create a table to store daily, monthly, and annual revenue reports.

The `revenue_report` table will store aggregated revenue data for each day, month, and year, allowing for historical analysis and easy retrieval.

Here is the SQL query.

```sql
CREATE TABLE `revenue_report` (
    `id` INT AUTO_INCREMENT PRIMARY KEY,
    `year` INT NOT NULL,
    `month` INT NOT NULL,
    `day` INT NOT NULL,
    `amount` DECIMAL(10, 2) NOT NULL
);
```
<br>

### 4Ô∏è‚É£ Creating Stored Procedures for Revenue Calculation

**Objective**: Create stored procedures to calculate and store daily, monthly, and annual revenue into the `revenue_report` table.

Stored procedures are used to perform actions that involve more complex logic and potentially multiple SQL statements. We'll create procedures that:
1. **Calculate daily revenue**: Sum the revenue for a specific day and store it in `revenue_report`.
2. **Calculate monthly revenue**: Sum the revenue for a specific month and store it in `revenue_report`.
3. **Calculate annual revenue**: Sum the revenue for a specific year and store it in `revenue_report`.

Here are the SQL query.

**Daily Revenue**

```sql
DELIMITER //

CREATE PROCEDURE calculate_daily_revenue(IN input_day DATE)
BEGIN
    DECLARE total_revenue DECIMAL(10, 2);
    SET total_revenue = (
        SELECT IFNULL(SUM(amount), 0)
        FROM invoice
        WHERE DATE(created_date) = input_day
    );

    -- Insert or update the revenue_report
    INSERT INTO revenue_report (year, month, day, amount)
    VALUES (YEAR(input_day), MONTH(input_day), DAY(input_day), total_revenue)
    ON DUPLICATE KEY UPDATE amount = total_revenue;
END //

DELIMITER ;
```

**Monthly Revenue**

```sql
DELIMITER //

CREATE PROCEDURE calculate_monthly_revenue(IN input_year INT, IN input_month INT)
BEGIN
    DECLARE total_revenue DECIMAL(10, 2);
    SET total_revenue = (
        SELECT IFNULL(SUM(amount), 0)
        FROM invoice
        WHERE YEAR(created_date) = input_year
          AND MONTH(created_date) = input_month
    );

    -- Insert or update the revenue_report
    INSERT INTO revenue_report (year, month, day, amount)
    VALUES (input_year, input_month, 0, total_revenue)
    ON DUPLICATE KEY UPDATE amount = total_revenue;
END //

DELIMITER ;
```

**Annual Revenue**

```sql
DELIMITER //

CREATE PROCEDURE calculate_annual_revenue(IN input_year INT)
BEGIN
    DECLARE total_revenue DECIMAL(10, 2);
    SET total_revenue = (
        SELECT IFNULL(SUM(amount), 0)
        FROM invoice
        WHERE YEAR(created_date) = input_year
    );

    -- Insert or update the revenue_report
    INSERT INTO revenue_report (year, month, day, amount)
    VALUES (input_year, 0, 0, total_revenue)
    ON DUPLICATE KEY UPDATE amount = total_revenue;
END //

DELIMITER ;
```

Here is the explanation on what the query actually done.
1. **Daily Revenue Procedure**
    - **Input**: `input_day` of type `DATE`
    - **Logic**: Sum `amount` from `invoice` where `created_date` matches the given day.
    - **Insert or Update**: Insert into `revenue_report` or update if the entry already exists for the given day.
2. **Monthly Revenue Procedure**
    - **Input**: `input_month` of type `DATE`.
    - **Logic**: Sum `amount` from `invoice` where the year and month of `created_date` match the given month.
    - **Insert or Update**: Insert into `revenue_report` or update if the entry already exists for the given month.
3. **Annual Revenue Procedure**
    - **Input**: `input_year` of type `INT`.
    - **Logic**: Sum `amount` from `invoice` where the year of `created_date` matches the given year.
    - **Insert or Update**: Insert into `revenue_report` or update if the entry already exists for the given year.

Now, it's testing time!
1. **Daily Revenue**
    
    Here is the result if the procedure is called.
    <br>

    ![Screenshots](/Week%2003/Lecture%2006/Assignment%2003/img/Task3.png).

    By using this query to check
    ```sql
    -- Daily revenue
    SELECT 
        DATE(created_date) AS date,
        SUM(amount) AS daily_revenue
    FROM invoice
    GROUP BY DATE(created_date)
    ORDER BY DATE(created_date);
    ```
    here is the result.
    <br>

    ![Screenshots](/Week%2003/Lecture%2006/Assignment%2003/img/Task32.png).

    We can see that the result of daily revenue on January 2nd, 2024 **match perfectly** with amount of 593.41.
    <br>

2. **Monthly Revenue**
    
    Here is the result if the procedure is called.
    <br>

    ![Screenshots](/Week%2003/Lecture%2006/Assignment%2003/img/Task4.png).

    By using this query to check
    ```sql
    -- Monthly revenue
    SELECT 
        YEAR(created_date) AS year,
        MONTH(created_date) AS month,
        SUM(amount) AS monthly_revenue
    FROM invoice
    GROUP BY YEAR(created_date), MONTH(created_date)
    ORDER BY YEAR(created_date), MONTH(created_date);
    ```
    here is the result.
    <br>

    ![Screenshots](/Week%2003/Lecture%2006/Assignment%2003/img/Task42.png).

    We can see that the result of daily revenue along June 2023 (6th month) **match perfectly** with amount of 576.32.
    <br>

3. **Annual Revenue**
    
    Here is the result if the procedure is called.
    <br>

    ![Screenshots](/Week%2003/Lecture%2006/Assignment%2003/img/Task5.png).

    By using this query to check
    ```sql
    -- Annual revenue
    SELECT 
        YEAR(created_date) AS year,
        SUM(amount) AS annual_revenue
    FROM invoice
    GROUP BY YEAR(created_date)
    ORDER BY YEAR(created_date);
    ```
    here is the result.
    <br>

    ![Screenshots](/Week%2003/Lecture%2006/Assignment%2003/img/Task52.png).

    We can see that the result of daily revenue along year 2023 **match perfectly** with amount of 5949.35.

All of the queries used on this assignment is available on [this sql file](/Week%2003/Lecture%2006/Assignment%2003/full_query.sql).